<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†°æ°´ä¸»æ©Ÿæ›´æ›æ•ˆç›Šè©•ä¼°è¨ˆç®—å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --color-primary: #2180a0;
            --color-primary-hover: #1a6680;
            --color-success: #22c55e;
            --color-error: #ef4444;
            --color-warning: #f59e0b;
            --color-bg: #f8fafc;
            --color-surface: #ffffff;
            --color-border: #e2e8f0;
            --color-text: #1e293b;
            --color-text-light: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, #1a6680 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 10px;
        }

        .card h3 {
            font-size: 14px;
            margin-top: 20px;
            margin-bottom: 12px;
            color: var(--color-text);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--color-text);
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 160, 0.1);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .chiller-block {
            background: #f0f9ff;
            border: 1px solid #cce5ff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            padding-right: 45px;
        }

        .chiller-block h4 {
            font-size: 14px;
            margin-bottom: 12px;
            color: var(--color-primary);
            font-weight: 600;
        }

        .btn-remove {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-remove:hover {
            background: #dc2626;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(33, 128, 160, 0.3);
        }

        .btn-secondary {
            background: var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-full {
            width: 100%;
        }

        .result-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid var(--color-success);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .result-card.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: var(--color-error);
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            color: var(--color-text-light);
            font-weight: 500;
        }

        .result-value {
            font-weight: 600;
            color: var(--color-primary);
            font-size: 16px;
        }

        .result-value.highlight {
            color: var(--color-success);
            font-size: 20px;
        }

        .chart-container {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--color-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-light);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-unit {
            font-size: 12px;
            color: var(--color-text-light);
        }

        .divider {
            height: 1px;
            background: var(--color-border);
            margin: 20px 0;
        }

        .warning-banner {
            background: #fef3c7;
            border-left: 4px solid var(--color-warning);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #92400e;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-light);
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        @media print {
            body {
                background: white;
            }
            .card {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>â„ï¸ å†°æ°´ä¸»æ©Ÿæ›´æ›æ•ˆç›Šè©•ä¼°è¨ˆç®—å™¨</h1>
            <p>å¿«é€Ÿè©•ä¼°å†°æ°´ä¸»æ©Ÿæ›´æ›æŠ•è³‡å›æ”¶å¹´é™èˆ‡ç¯€èƒ½æ•ˆç›Š</p>
        </header>

        <div class="layout">
            <!-- å·¦å´ï¼šè¼¸å…¥è¡¨å–® -->
            <div>
                <div class="card">
                    <h2>ğŸ”§ ç³»çµ±åƒæ•¸è¨­å®š</h2>

                    <h3>å…±åŒé‹è½‰åƒæ•¸</h3>
                    <div class="form-group">
                        <label for="electricityPrice">é›»è²»å–®åƒ¹ (å…ƒ/kWh)</label>
                        <input type="number" id="electricityPrice" value="3.95" min="0.1" step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="engineeringCost">é ä¼°å·¥ç¨‹è²»ç”¨ (å…ƒ/RT)</label>
                        <input type="number" id="engineeringCost" value="10000" min="0" step="500">
                    </div>

                    <div class="divider"></div>
                    <h3>é‹è½‰æ™‚æ•¸è¨­å®š</h3>
                    <div style="background: #f0f9ff; border: 1px solid #cce5ff; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; margin-bottom: 12px; cursor: pointer;">
                            <input type="checkbox" id="useCommonHours" checked style="width: auto; margin-right: 8px;">
                            <span style="font-size: 13px; font-weight: 500;">æ‰€æœ‰å†°æ©Ÿä½¿ç”¨ç›¸åŒé‹è½‰æ™‚æ•¸</span>
                        </label>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="annualHours">å…¨å¹´é‹è½‰æ™‚æ•¸ (å°æ™‚)</label>
                            <input type="number" id="annualHours" value="7000" min="1" step="100" onchange="updateCommonHours()">
                        </div>
                    </div>

                    <div class="divider"></div>
                    <h3>ç¾æœ‰å†°æ©Ÿè³‡è¨Š</h3>

                    <div id="chillersList"></div>

                    <button class="btn btn-success" onclick="addChiller()">+ æ–°å¢å†°æ©Ÿ</button>
                    <button class="btn btn-secondary" onclick="clearAllChillers()">æ¸…é™¤å…¨éƒ¨</button>

                    <div class="divider"></div>
                    <h3>æ”¹å–„æ–¹æ¡ˆè¨­å®š</h3>

                    <div id="newEfficienciesList"></div>

                    <button class="btn btn-primary btn-full" onclick="calculate()">ğŸ“Š è¨ˆç®—æ•ˆç›Š</button>
                </div>
            </div>

            <!-- å³å´ï¼šçµæœé¡¯ç¤º -->
            <div>
                <div id="resultsContainer"></div>
            </div>
        </div>

        <!-- åœ–è¡¨å€åŸŸ -->
        <div id="chartsContainer"></div>

        <!-- å°å‡ºæŒ‰éˆ• -->
        <div style="text-align: center; margin-bottom: 30px;" id="exportButtons"></div>
    </div>

    <script>
        let chillers = [];
        let lastCalculationResults = null;

        function addChiller() {
            const id = Date.now();
            const commonHours = parseFloat(document.getElementById('annualHours').value);
            const chiller = {
                id: id,
                name: `å†°æ©Ÿ #${chillers.length + 1}`,
                tons: 100,
                currentEfficiency: 0.78,
                operatingHours: commonHours,
                loadFactor: 60,
                newEfficiency: 0.576
            };
            chillers.push(chiller);
            renderChillers();
        }

        function updateCommonHours() {
            const useCommon = document.getElementById('useCommonHours').checked;
            const commonHours = parseFloat(document.getElementById('annualHours').value);
            
            if (useCommon) {
                chillers.forEach(chiller => {
                    chiller.operatingHours = commonHours;
                });
                renderChillers();
            }
        }

        function removeChiller(id) {
            chillers = chillers.filter(c => c.id !== id);
            renderChillers();
        }

        function clearAllChillers() {
            if (chillers.length === 0) {
                alert('æ²’æœ‰å†°æ©Ÿå¯æ¸…é™¤');
                return;
            }
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å†°æ©Ÿå—ï¼Ÿ')) {
                chillers = [];
                renderChillers();
                document.getElementById('resultsContainer').innerHTML = '';
                document.getElementById('chartsContainer').innerHTML = '';
                document.getElementById('exportButtons').innerHTML = '';
            }
        }

        function renderChillers() {
            const container = document.getElementById('chillersList');
            if (chillers.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8; font-size: 13px;">é‚„æ²’æœ‰æ–°å¢ä»»ä½•å†°æ©Ÿ</p>';
                return;
            }

            container.innerHTML = chillers.map((chiller, index) => `
                <div class="chiller-block">
                    <h4>${chiller.name}</h4>
                    <button class="btn-remove" onclick="removeChiller(${chiller.id})">ç§»é™¤</button>
                    
                    <div class="input-row">
                        <div class="form-group">
                            <label>å†·å‡å™¸æ•¸ (RT)</label>
                            <input type="number" value="${chiller.tons}" min="1" step="10" 
                                   onchange="updateChiller(${chiller.id}, 'tons', this.value)">
                        </div>
                        <div class="form-group">
                            <label>ç¾æ³æ•ˆç‡ (kW/RT)</label>
                            <input type="number" value="${chiller.currentEfficiency}" min="0.1" step="0.01" 
                                   onchange="updateChiller(${chiller.id}, 'currentEfficiency', this.value)">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label>å¹´é‹è½‰æ™‚æ•¸ (å°æ™‚)
                                <span style="font-size: 11px; color: #94a3b8; font-weight: normal;">
                                    ${document.getElementById('useCommonHours').checked ? '(å·²é–å®šä½¿ç”¨å…±åŒæ™‚æ•¸)' : '(è‡ªè¨‚)'}
                                </span>
                            </label>
                            <input type="number" value="${chiller.operatingHours}" min="1" step="100" 
                                   ${document.getElementById('useCommonHours').checked ? 'disabled' : ''}
                                   onchange="updateChiller(${chiller.id}, 'operatingHours', this.value); if(!document.getElementById('useCommonHours').checked) {}">
                        </div>
                        <div class="form-group">
                            <label>å¹³å‡è² è¼‰ç‡ (%)</label>
                            <input type="number" value="${chiller.loadFactor}" min="0" max="100" step="1" 
                                   onchange="updateChiller(${chiller.id}, 'loadFactor', this.value)">
                        </div>
                    </div>
                </div>
            `).join('');
            renderNewEfficiencies();
        }

        function updateChiller(id, field, value) {
            const chiller = chillers.find(c => c.id === id);
            if (chiller) {
                chiller[field] = parseFloat(value);
            }
        }

        function renderNewEfficiencies() {
            const container = document.getElementById('newEfficienciesList');
            if (chillers.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '<p style="font-size: 13px; color: #64748b; margin-bottom: 12px;">å„å†°æ©Ÿæ”¹å–„å¾Œæ•ˆç‡</p>' + chillers.map(chiller => `
                <div class="form-group">
                    <label>å†°æ©Ÿ #${chillers.indexOf(chillers.find(c => c.id === chiller.id)) + 1} æ”¹å–„å¾Œæ•ˆç‡ (kW/RT)</label>
                    <input type="number" value="${chiller.newEfficiency}" min="0.1" step="0.01" 
                           onchange="updateChiller(${chiller.id}, 'newEfficiency', this.value)">
                </div>
            `).join('');
        }

        function calculate() {
            if (chillers.length === 0) {
                alert('è«‹å…ˆæ–°å¢è‡³å°‘ä¸€å°å†°æ©Ÿ');
                return;
            }

            const useCommonHours = document.getElementById('useCommonHours').checked;
            const annualHours = parseFloat(document.getElementById('annualHours').value);
            const electricityPrice = parseFloat(document.getElementById('electricityPrice').value);
            const engineeringCost = parseFloat(document.getElementById('engineeringCost').value);

            if (!annualHours || !electricityPrice || !engineeringCost) {
                alert('è«‹å¡«å…¥æ‰€æœ‰åƒæ•¸');
                return;
            }

            let totalCurrentCost = 0;
            let totalNewCost = 0;
            let totalTons = 0;
            let totalInvestment = 0;
            let details = [];

            chillers.forEach((chiller, index) => {
                const tons = parseFloat(chiller.tons);
                const currentEff = parseFloat(chiller.currentEfficiency);
                const newEff = parseFloat(chiller.newEfficiency);
                const hours = useCommonHours ? annualHours : parseFloat(chiller.operatingHours);
                const loadFactor = parseFloat(chiller.loadFactor) / 100;

                // ç¾æ³å¹´è€—é›» = å†·å‡å™¸ Ã— å¹´é‹è½‰æ™‚æ•¸ Ã— è² è¼‰ç‡ Ã— ç¾æ³æ•ˆç‡(kW/RT)
                const currentPower = tons * hours * loadFactor * currentEff;
                const currentCost = currentPower * electricityPrice;

                // æ”¹å–„å¾Œå¹´è€—é›» = å†·å‡å™¸ Ã— å¹´é‹è½‰æ™‚æ•¸ Ã— è² è¼‰ç‡ Ã— æ–°æ•ˆç‡(kW/RT)
                const newPower = tons * hours * loadFactor * newEff;
                const newCost = newPower * electricityPrice;

                const yearSaving = currentCost - newCost;
                const investment = tons * engineeringCost;

                totalCurrentCost += currentCost;
                totalNewCost += newCost;
                totalTons += tons;
                totalInvestment += investment;

                details.push({
                    name: chiller.name,
                    tons: tons,
                    currentCost: currentCost,
                    newCost: newCost,
                    yearSaving: yearSaving,
                    investment: investment
                });
            });

            const annualSaving = totalCurrentCost - totalNewCost;
            const paybackYears = totalInvestment > 0 ? totalInvestment / annualSaving : 0;

            lastCalculationResults = {
                details: details,
                totalTons: totalTons,
                totalCurrentCost: totalCurrentCost,
                totalNewCost: totalNewCost,
                annualSaving: annualSaving,
                totalInvestment: totalInvestment,
                paybackYears: paybackYears,
                totalCurrentPower: totalCurrentCost / electricityPrice,
                totalNewPower: totalNewCost / electricityPrice
            };

            displayResults();
            generateCharts();
            showExportButtons();
        }

        function displayResults() {
            const r = lastCalculationResults;
            const container = document.getElementById('resultsContainer');

            const paybackColor = r.paybackYears <= 5 ? 'highlight' : '';

            container.innerHTML = `
                <div class="card">
                    <h2>ğŸ“ˆ æ•ˆç›Šåˆ†æçµæœ</h2>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">ç¾æ³å¹´è€—é›»</div>
                            <div class="stat-value">${(r.totalCurrentPower / 1000).toFixed(0)}</div>
                            <div class="stat-unit">åƒåº¦</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">æ”¹å–„å¾Œå¹´è€—é›»</div>
                            <div class="stat-value">${(r.totalNewPower / 1000).toFixed(0)}</div>
                            <div class="stat-unit">åƒåº¦</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">å¹´åº¦ç¯€çœé›»è²»</div>
                            <div class="stat-value">${formatCurrency(r.annualSaving)}</div>
                            <div class="stat-unit">å…ƒ</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">æŠ•è³‡æˆæœ¬</div>
                            <div class="stat-value">${formatCurrency(r.totalInvestment)}</div>
                            <div class="stat-unit">å…ƒ</div>
                        </div>
                    </div>

                    <div class="result-card">
                        <div class="result-row">
                            <span class="result-label">ç¾æ³å¹´é›»è²»æˆæœ¬</span>
                            <span class="result-value">${formatCurrency(r.totalCurrentCost)}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">æ”¹å–„å¾Œå¹´é›»è²»æˆæœ¬</span>
                            <span class="result-value">${formatCurrency(r.totalNewCost)}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">å¹´åº¦ç¯€çœé›»è²»</span>
                            <span class="result-value" style="color: #ef4444;">-${formatCurrency(r.annualSaving)}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">é ä¼°å·¥ç¨‹æŠ•è³‡</span>
                            <span class="result-value">${formatCurrency(r.totalInvestment)}</span>
                        </div>
                        <div class="result-row" style="border-bottom: 2px solid rgba(0,0,0,0.1); margin-bottom: 10px; padding-bottom: 10px;">
                            <span class="result-label" style="font-weight: 700;">â­ æŠ•è³‡å›æ”¶å¹´é™</span>
                            <span class="result-value ${paybackColor}">${r.paybackYears.toFixed(2)} å¹´</span>
                        </div>
                    </div>

                    ${r.paybackYears <= 5 ? '<div class="warning-banner">âœ… å›æ”¶å¹´é™ä¸è¶…é5å¹´ï¼ŒæŠ•è³‡æ•ˆç›Šè‰¯å¥½</div>' : '<div class="warning-banner">âš ï¸ å›æ”¶å¹´é™è¶…é5å¹´ï¼Œå»ºè­°é‡æ–°è©•ä¼°æ–¹æ¡ˆ</div>'}
                </div>
            `;
        }

        function generateCharts() {
            const r = lastCalculationResults;
            const container = document.getElementById('chartsContainer');

            // åœ–è¡¨1ï¼šå†°æ©Ÿå°æ¯”åœ–
            const trace1Before = {
                x: r.details.map(d => d.name),
                y: r.details.map(d => d.currentCost),
                name: 'æ”¹é€ å‰å¹´é›»è²»',
                marker: { color: '#ef4444' },
                type: 'bar'
            };

            const trace1After = {
                x: r.details.map(d => d.name),
                y: r.details.map(d => d.newCost),
                name: 'æ”¹é€ å¾Œå¹´é›»è²»',
                marker: { color: '#22c55e' },
                type: 'bar'
            };

            const layout1 = {
                title: 'å„å†°æ©Ÿæ”¹é€ å‰å¾Œå¹´åº¦é›»è²»å°æ¯”',
                barmode: 'group',
                yaxis: { title: 'å¹´åº¦é›»è²» (å…ƒ)' },
                xaxis: { title: 'å†°æ©Ÿç·¨è™Ÿ' },
                hovermode: 'x unified',
                margin: { b: 100 }
            };

            // åœ–è¡¨2ï¼šå¹´è€—é›»åº¦æ•¸å°æ¯”
            const trace2Before = {
                x: r.details.map(d => d.name),
                y: r.details.map(d => d.currentCost / (parseFloat(document.getElementById('electricityPrice').value))),
                name: 'æ”¹é€ å‰å¹´è€—é›»',
                marker: { color: '#f59e0b' },
                type: 'bar'
            };

            const trace2After = {
                x: r.details.map(d => d.name),
                y: r.details.map(d => d.newCost / (parseFloat(document.getElementById('electricityPrice').value))),
                name: 'æ”¹é€ å¾Œå¹´è€—é›»',
                marker: { color: '#3b82f6' },
                type: 'bar'
            };

            const layout2 = {
                title: 'å„å†°æ©Ÿæ”¹é€ å‰å¾Œå¹´åº¦è€—é›»åº¦æ•¸å°æ¯”',
                barmode: 'group',
                yaxis: { title: 'å¹´è€—é›»é‡ (kWh)' },
                xaxis: { title: 'å†°æ©Ÿç·¨è™Ÿ' },
                hovermode: 'x unified',
                margin: { b: 100 }
            };

            // åœ–è¡¨3ï¼šæŠ•è³‡å›æ”¶æ›²ç·š
            const years = Array.from({length: Math.ceil(r.paybackYears) + 3}, (_, i) => i);
            const cumulativeSavings = years.map(y => y * r.annualSaving);
            const investmentLine = Array(years.length).fill(r.totalInvestment);

            const trace3Savings = {
                x: years,
                y: cumulativeSavings,
                name: 'ç´¯è¨ˆç¯€çœé›»è²»',
                line: { color: '#22c55e', width: 3 },
                fill: 'tozeroy',
                fillcolor: 'rgba(34, 197, 94, 0.1)'
            };

            const trace3Investment = {
                x: years,
                y: investmentLine,
                name: 'æŠ•è³‡æˆæœ¬',
                line: { color: '#ef4444', width: 2, dash: 'dash' }
            };

            const layout3 = {
                title: 'æŠ•è³‡å›æ”¶æ›²ç·š',
                yaxis: { title: 'é‡‘é¡ (å…ƒ)' },
                xaxis: { title: 'å¹´æ•¸' },
                hovermode: 'x unified',
                annotations: [{
                    x: r.paybackYears,
                    y: r.totalInvestment,
                    text: `å›æ”¶é»: ${r.paybackYears.toFixed(2)}å¹´`,
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#2180a0',
                    ax: 40,
                    ay: -40
                }]
            };

            container.innerHTML = `
                <div class="chart-container">
                    <div id="chart1"></div>
                </div>
                <div class="chart-container">
                    <div id="chart2"></div>
                </div>
                <div class="chart-container">
                    <div id="chart3"></div>
                </div>
            `;

            Plotly.newPlot('chart1', [trace1Before, trace1After], layout1, { responsive: true });
            Plotly.newPlot('chart2', [trace2Before, trace2After], layout2, { responsive: true });
            Plotly.newPlot('chart3', [trace3Savings, trace3Investment], layout3, { responsive: true });
        }

        function showExportButtons() {
            const container = document.getElementById('exportButtons');
            container.innerHTML = `
                <button class="btn btn-primary" onclick="exportToPDF()">ğŸ“„ ä¸‹è¼‰PDFå ±å‘Š</button>
                <button class="btn btn-secondary" onclick="exportToCSV()">ğŸ“Š ä¸‹è¼‰CSVæ•¸æ“š</button>
                <button class="btn btn-secondary" onclick="printPage()">ğŸ–¨ï¸ åˆ—å°</button>
            `;
        }

        function exportToPDF() {
            const element = document.querySelector('.container');
            const opt = {
                margin: 10,
                filename: 'å†°æ°´ä¸»æ©Ÿæ›´æ›æ•ˆç›Šè©•ä¼°å ±å‘Š.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            html2pdf().set(opt).save().html(element);
        }

        function exportToCSV() {
            const r = lastCalculationResults;
            let csv = 'å†°æ°´ä¸»æ©Ÿæ›´æ›æ•ˆç›Šè©•ä¼° - è©³ç´°æ•¸æ“š\n\n';
            csv += 'å†°æ©Ÿåç¨±,å†·å‡å™¸æ•¸,ç¾æ³å¹´é›»è²»,æ”¹é€ å¾Œå¹´é›»è²»,å¹´åº¦ç¯€çœ,å·¥ç¨‹æŠ•è³‡\n';

            r.details.forEach(d => {
                csv += `${d.name},${d.tons},${d.currentCost.toFixed(0)},${d.newCost.toFixed(0)},${d.yearSaving.toFixed(0)},${d.investment.toFixed(0)}\n`;
            });

            csv += `\nåˆè¨ˆ,${r.totalTons},${r.totalCurrentCost.toFixed(0)},${r.totalNewCost.toFixed(0)},${r.annualSaving.toFixed(0)},${r.totalInvestment.toFixed(0)}\n`;
            csv += `\næŠ•è³‡å›æ”¶å¹´é™,,,,${r.paybackYears.toFixed(2)},å¹´\n`;

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'å†°æ°´ä¸»æ©Ÿè©•ä¼°æ•¸æ“š.csv';
            link.click();
        }

        function printPage() {
            window.print();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(value);
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            addChiller();
            // åŒæ­¥ checkbox ç‹€æ…‹è®ŠåŒ–
            document.getElementById('useCommonHours').addEventListener('change', function() {
                if (this.checked) {
                    updateCommonHours();
                }
                renderChillers();
            });
        };
    </script>
</body>
</html>
